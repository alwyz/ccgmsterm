;XMODEM ROUTINESXMSTAT .BYT 0XMOBLK .BYT 0XMOCHK .BYT 0XMOBAD .BYT 0XMOWBF .BYT 0XMODEL .BYT 0XMOEND .BYT 0XMOSTK .BYT $FF;XMOSND TSX STX XMOSTK JSR XMOSETXMUPL1 LDA #14 ;60 SECS JSR XMMGET BEQ XMUPL2XMUPAB JMP XMABRTXMUPL2 CMP #CAN BEQ XMUPAB CMP #NAK BNE XMUPL1XMUPLL JSR XMOCBF STY XMOBAD LDA #SOH STA (XMOBUF),Y INY LDA XMOBLK STA (XMOBUF),Y INY EOR #$FF STA (XMOBUF),Y INYXMSND1 LDX #2 JSR CHKINXMSND2 JSR GETIN LDX $90  ;STATUS STX XMOEND BEQ XMSND4XMSND3 LDA #CPMEOFXMSND4 STA (XMOBUF),Y CLC ADC XMOCHK STA XMOCHK INY CPY #131 BCS XMSND5 LDX XMOEND BEQ XMSND2 BNE XMSND3XMSND5 STA (XMOBUF),Y JSR CLRCHNXMSND6 JSR XMRCLR LDX #5 JSR CHKOUT LDY #0XMSND7 LDA (XMOBUF),Y JSR CHROUT INY CPY #132 BCC XMSND7 JSR CLRCHN JSR XMRICL LDA #3 JSR XMMGET BNE XMSNBD CMP #CAN BNE XMSND8 JMP XMABRTXMSND8 CMP #NAK BNE XMSND9XMSNBD JSR CHROUT JMP XMSND6XMSND9 CMP #ACK BNE XMSNBDXMSNNX LDA #'-' JSR GOOBAD LDX XMOEND BNE XMSNEN INC XMOBLK INC XMOWBF JMP XMUPLLXMSNEN LDA #0 STA XMOENDXMSNE1 LDX #5 JSR CHKOUT LDA #EOT JSR CHROUT LDA #3 JSR XMMGET BNE XMSNE2 CMP #ACK BNE XMSNE2 JMP XMFNOKXMSNE2 INC XMOEND LDA XMOEND CMP #10 BCC XMSNE1 JMP XMNEOT;;XMOSET LDA #1 STA XMOBLK LDA #0 STA XMOWBF STA XMOBADXMOCBF LDA XMOWBF AND #3 STA XMOWBF LDA #<XMOSCN STA XMOBUF LDA #>XMOSCN STA XMOBUF+1 LDX XMOWBF BEQ XMOCB2XMOCB1 LDA XMOBUF CLC ADC #$85 STA XMOBUF LDA XMOBUF+1 ADC #0 STA XMOBUF+1 DEX BNE XMOCB1XMOCB2  LDY #0 STY XMOCHK STY XMOEND RTSXMRCLR LDA $029D ;CLEAR RS232 OUTPUT STA $029EXMRICL LDA $029B ;AND INPUT BUFFERS STA $029C RTSXMMGET STA XMODEL LDA #0 STA $A1 STA $A2 JSR $F04F ;"CHKIN" MODEMXMOGT1 JSR $F14E ;RS232 INPUT TAX LDA $0297 AND #8 BNE XMMGT2 TXA LDX #0 RTSXMMGT2 JSR XCHKCM LDA $A1 CMP XMODEL BCC XMOGT1 JSR CLRCHN AND #0 LDX #1 RTSXINCBD LDA #':' JSR GOOBAD INC XMOBAD LDA XMOBAD CMP #10 BCS XMTRYS RTSXCHKCM LDX 653 CPX #2 BEQ XMCMAB RTSXMFNOK LDA #'*' JSR GOOBAD LDA #0.BYT $2CXMABRT LDA #1.BYT $2CXMNEOT LDA #2.BYT $2CXMTRYS LDA #3.BYT $2CXMSYNC LDA #4.BYT $2CXMCMAB LDA #5 STA XMSTATXMOEXT  TSX CPX XMOSTK BEQ XMOEX2 PLA CLC BCC XMOEXTXMOEX2 JSR XMRCLR LDA XMSTAT CMP #4 BCC XMOEX4 LDX #5 JSR CHKOUT LDY #8 LDA #CANXMOEX3 JSR CHROUT DEY BPL XMOEX3XMOEX4 JSR CLRCHN LDA #2 JMP CLOSE;XMORCV TSX STX XMOSTK JSR 61310 JSR 61310 JSR XMOSET BEQ XMORCPXMORC0 JSR XINCBDXMORCP LDA #0 STA XMOENDXMORC1 LDX #5 JSR CHKOUT LDA #NAK JSR CHROUT JSR CLRCHNXMORCL LDA #2 JSR XMMGET BEQ XMORC2XMORCI INC XMOEND LDA XMOEND CMP #10 BCC XMORC1XMRCAB JMP XMABRTXMORC2 CMP #CAN BEQ XMRCAB CMP #EOT BNE XMORCS LDA #1 STA XMOEND JMP XMORAKXMORCS CMP #SOH BNE XMORCI JSR XMOCBF BEQ XMORC4XMORC3 LDA #2 JSR XMMGET BNE XMORC0XMORC4 STA (XMOBUF),Y INY CPY #132 BCC XMORC3 LDY #1 LDA (XMOBUF),Y INY EOR (XMOBUF),Y CMP #$FF BNE XMORC0 LDA #0XMORC5 INY CPY #131 BCS XMORC6 ADC (XMOBUF),Y CLC BCC XMORC5XMORC6 STA XMOCHK CMP (XMOBUF),Y BNE XMORC0 LDY #1 LDA (XMOBUF),Y CMP XMOBLK BEQ XMORC7 LDX XMOBLK DEX TXA CMP (XMOBUF),Y BNE XMORSA LDA #'/' JSR GOOBAD JMP XMORC9XMORSA  JMP XMSYNCXMORC7 JSR CLRCHN LDX #2 JSR CHKOUT LDY #3XMORC8 LDA (XMOBUF),Y JSR CHROUT INY CPY #131 BCC XMORC8XMORC9 LDA #0 STA XMOEND INC XMOBLK JSR CLRCHN LDA #'-' JSR GOOBADXMORAK INC XMOWBF LDX #5 JSR CHKOUT LDA #ACK JSR CHROUT JSR CLRCHN LDA #0 STA XMOBAD LDA XMOEND BNE XMOR10 JMP XMORCLXMOR10 JMP XMFNOK;XMOPSU .BYT 2,'PRG, ',2,'SEQ, OR ',2,'USR? ',0XMOTYP LDA #<XMOPSU LDY #>XMOPSU JSR OUTSTR JSR SAVECHXMOTY2 JSR GETIN BEQ XMOTY2 AND #$7F LDX #3XMOTY3 CMP UPLTYP,X BEQ XMOTY4 DEX BNE XMOTY3 BEQ XMOTY2XMOTY4 STX PBUF+27 RTS;XMO1ER .BYT 13,T,'RANSFER CANCELLED.',0XMO2ER .BYT 13,E,O,T,' NOT ACKNOWLEDGED.',0XMO3ER .BYT 13,T,'OO MANY BAD BLOCKS!',0XMO4ER .BYT 13,CS,'YNC LOST!',0XMOUPL JSR XMOSND JMP XMODONXMODOW JSR XMORCVXMODON LDA #$0D JSR CHROUT LDA XMSTAT BNE XMODN2 JMP XFRDUNXMODN2 CMP #5 BEQ XMODNA CMP #1 BNE XMODN3 LDA #<XMO1ER LDY #>XMO1ER BNE XMODNPXMODN3 CMP #2 BNE XMODN4 LDA #<XMO2ER LDY #>XMO2ER BNE XMODNPXMODN4 CMP #3 BNE XMODN5 LDA #<XMO3ER LDY #>XMO3ER BNE XMODNPXMODN5 LDA #<XMO4ER LDY #>XMO4ERXMODNP JSR OUTSTR JSR GONG LDA #$0D JSR CHROUTXMODNA JMP ABORTXXMDTXT .BYT 13,13,5,CX,M,'ODEM ',0XFERFN PHA LDA PROTOC AND #1 STA PROTOC BEQ XFERPT LDA #<XMDTXT LDY #>XMDTXT JSR OUTSTR JMP XFERWCXFERPT LDA #<PTRTXT LDY #>PTRTXT JSR OUTSTRXFERWC PLA BNE XFERDW LDA #<UPLTXT LDY #>UPLTXT CLC BCC ENTFNTXFERDW LDA #<DOWTXT LDY #>DOWTXTENTFNT JSR OUTSTR LDA #<LODTXT LDY #>LODTXT JSR OUTSTRENTFIL LDA #<FLNTXT LDY #>FLNTXT LDX #16 JSR INPUT PHP LDA #$0D JSR CHROUT PLP RTSABORTX JSR CLRCHN LDA #<ABRTXT LDY #>ABRTXT JSR OUTSTR JSR COBACK LDA #$02 JSR CLOSE JMP MAINXFERMD  PHA JMP XFERM0XFRMSG PHA LDA #15 STA TEXTCL STA BACKGR LDA #$93 JSR CHROUT LDA #BCOLOR STA BACKGRXFERM0  LDA #13 STA 214 LDA #$0D JSR CHROUT LDA #06 STA TEXTCL LDX #40 LDA #192XFERM1  JSR CHROUT DEX BNE XFERM1 LDA #<XFRMED LDY #>XFRMED JSR OUTSTR PLA BNE XFERM2 LDA #<UPLTXT LDY #>UPLTXT CLC BCC XFERM3XFERM2 LDA #<DOWTXT LDY #>DOWTXTXFERM3 JSR OUTSTR LDA #<XFRTXT LDY #>XFRTXT JSR OUTSTR LDY #0XFERM4  LDA INPBUF,Y JSR CHROUT INY CPY MAX BNE XFERM4 LDA INPBUF,Y JSR CHROUT LDA INPBUF+1,Y JSR CHROUT LDA #$0D JSR CHROUT LDA #<XF2TXT LDY #>XF2TXT JMP OUTSTRMARGIN LDA #<MRGTXT LDY #>MRGTXT JMP OUTSTRUPLTYP .BYT 0,'P','S','U'F1    ;UPLOAD JSR COSAVE LDA #0 STA MULCNT JSR XFERFN BNE UPLFFF JMP ABORTXUPLFFF LDY MAX LDA #',' STA INPBUF,Y LDA #'P' STA INPBUF+1,Y JSR FILTES BEQ UPLFIL LDY MAX LDA #'S' STA INPBUF+1,Y JSR FILTES BEQ UPLFIL LDY MAX LDA #'U' STA INPBUF+1,YUPLMEN JSR FILTES BEQ UPLFIL PHA LDX #$0F JSR CHKIN PLA JMP DRVER3UPLFIL LDY MAX LDX #03FLTPSR  LDA UPLTYP,X CMP INPBUF+1,Y BEQ FLTPFO DEX BNE FLTPSRFLTPFO  STX PBUF+27 JMP UPLOKFILTES LDY MAX INY INY TYA LDX #<INPBUF LDY #>INPBUF JSR SETNAM LDA #02 LDX DISKDV LDY #00 JSR SETLFSFILOPN  JSR OPEN LDX #15 JSR CHKIN JSR GETIN CMP #'0' BEQ FILTSO PHP PHA LDA #$02 JSR CLOSE PLA PLPFILTSO  RTSUPLOK LDA #0 JSR XFRMSG JSR CLRCHN LDA PROTOC BEQ UPLOK2 JSR MARGIN JMP XMOUPLUPLOK2 JSR P49173 JSR P49164 LDA INPBUF CMP #01 BNE UPLCON JSR BELL JMP ABORTXUPLCON JSR MARGIN JSR P49173 LDA #$FF STA PBUF+24 JSR P49158XFREND LDA #02 JSR CLOSE JSR CLRCHN LDA #$0D JSR CHROUT LDA MULCNT BEQ XFRNRM RTSXFRNRM LDA INPBUF CMP #$01 BNE XFRDUN JMP ABORTXXFRDUN LDA #$0D JSR CHROUT JSR GONG JMP MAINF3    ;DOWNLOAD LDA #0 STA MULCNT JSR COSAVE LDA #$01 JSR XFERFN BNE DOWFOK JMP ABORTXDOWFOK LDA PROTOC BEQ DOWFO2 JSR XMOTYP JMP DOWMENDOWFO2 LDY MAX LDA #160 STA INPBUF,Y STA INPBUF+1,YDOWMEN  LDA #01 JSR XFRMSG LDX PROTOC BNE DOWCON LDA INPBUF PHA JSR CLRCHN JSR P49173 JSR P49161 LDX INPBUF PLA STA INPBUF LDA MULCNT BNE DOWCON CPX #01 BNE DOWCONDOWABT JSR BELL JMP ABORTXDOWCON LDX #$FF STX PBUF+24 LDX #$0F JSR CHKOUT LDA #'I' JSR CHROUT LDA #'0' JSR CHROUT LDA #$0D JSR CHROUT JSR CLRCHN LDX #$0F JSR CHKOUT LDA #'S' JSR CHROUT LDA #'0' JSR CHROUT LDA #':' JSR CHROUT LDX #0SCRLOP LDA INPBUF,X JSR CHROUT INX CPX MAX BNE SCRLOP LDA #$0D JSR CHROUT JSR DOWSFN LDA #1 JSR XFERMD JSR MARGIN JMP DOWOPNDOWSFN JSR CLRCHN LDX MAX LDA #',' STA INPBUF,X STA INPBUF+2,X INX LDA #'W' STA INPBUF+2,X LDA PROTOC BNE DOWKSP LDA MULCNT BNE DOWKSP LDY PBUF+27 LDA UPLTYP,Y STA INPBUF,XDOWKSP  LDA MAX CLC ADC #$04 LDX #<INPBUF LDY #>INPBUF JSR SETNAM LDA #02 LDX DISKDV TAY JMP SETLFSDOWOPN JSR FILOPN BEQ DOWOP2 PHA LDX #$0F JSR CHKIN PLA JMP DRVER3DOWOP2 LDA PROTOC BEQ DOWOP3 JMP XMODOWDOWOP3 LDA #0 STA $A2DWWAIT LDA $A2 CMP #85 BCC DWWAIT JSR 61310 JSR P49173 JSR P49155 JMP XFREND;SNDTXT  .BYT 13,13,5,2,'READ OR',2,'SEND FILE? ',00F2 LDX 653 CPX #02 BNE SEND JMP CF1;SEND TEXTFILESEND JSR COSAVE LDA #<SNDTXT LDY #>SNDTXT JSR OUTSTR JSR SAVECHSNDLOP JSR GETIN CMP #'S' BNE SNDC1 LDX #$40 BNE SNDFILSNDC1 CMP #'R' BNE SNDC2 LDX #0 BEQ SNDFILSNDC2 CMP #$0D BNE SNDLOP JSR RESTCH LDA #$0D JSR CHROUTSNDABT JMP ABORTXSNDFIL ORA #$80 JSR OUTCAP LDA #$0D JSR CHROUT STX BUFFLG STX BUFFL2 JSR ENTFIL BEQ SNDABT LDA #$0D JSR CHROUT LDA MAX LDX #<INPBUF LDY #>INPBUF JSR SETNAM LDA #02 LDX DISKDV TAY JSR SETLFS JSR OPEN LDX #$05 JSR CHKOUT LDA #15 JSR CHROUT JSR DSKOUT LDA #02 JSR CLOSE JSR COCHNG LDA #$0D JSR CHROUT JMP DRVERRTMSETL LDX #0 STX $A2TMLOOP LDX $A2 CPX #$03 ;***TIME DEL BCC TMLOOP LDX #255TMLOP2 DEX BNE TMLOP2 RTS;;DISK OUTPUT ROUTINEDSKOUT JSR CLRCHN JSR CURPRT LDA BUFFLG  ;BUFFLG 00=DISK BPL DSKMO   ;$40=DISK W. DELAY JSR MEMGET  ;$80=MEMORY GET BIT BUFFLG  ;$FF=MEM W. DELAY BVS TIMDEL LDX #$FFMRLOOP DEX BNE MRLOOP BEQ CHSTATDSKMO LDX #02 JSR CHKIN JSR GETINTIMDEL BIT BUFFLG BVC CHSTAT JSR TMSETLCHSTAT PHA LDA STATUS AND #$40 BNE DSKEXT JSR CLRCHN JSR CUROFF PLA PHA JSR CTRLCK JSR CHROUT JSR QIMOFF LDX BUFFL2 ;NON ZERO=TO MODEM BNE DSKMO1 PLA JMP CHKKEYDSKMO1 LDX #05 JSR CHKOUT PLA LDX GRASFL BEQ DSKMO2 JSR CATOSADSKMO2 JSR CHROUTCHKKEY JSR KEYPRS BEQ DSKOUT CMP #3 BEQ DSKEX2 CMP #'S' BNE DSKWAT LDA BUFFLG BPL DSKWAT JSR SKPBUF LDX STATUS BNE DSKEX2 JMP DSKOUTDSKWAT JSR KEYPRS BEQ DSKWAT JMP DSKOUTDSKEXT PLADSKEX2 JSR CLRCHN JMP CUROFFKEYPRS JSR CLRCHN JSR GETIN CMP #0 RTSOUTSTR STY $23 STA $22 LDY #0OUTST1 LDA ($22),Y BEQ OUTSTE CMP #2 BEQ HILITE CMP #03 BNE OUTST2 INY LDA ($22),Y STA 214 LDA #$0D JSR CHROUT LDA #145 JSR CHROUT INY LDA ($22),Y STA 211 BNE OUTST4OUTST2 CMP #$C1 BCC OUTST3 CMP #$DB BCS OUTST3 LDA 53272 AND #$02 PHP LDA ($22),Y PLP BNE OUTST3 AND #$7FOUTST3 JSR CHROUTOUTST4 INY BNE OUTST1 INC $23 BNE OUTST1OUTSTE RTSHILITE LDA TEXTCL PHA LDA #1 STA TEXTCL LDA #18  ;RVS-ON JSR CHROUT LDA #161 JSR CHROUT LDA 53272 AND #2 PHP INY LDA ($22),Y PLP BEQ HILIT2 ORA #$80HILIT2  JSR CHROUT LDA #182 JSR CHROUT PLA STA TEXTCL LDA #146 BNE OUTST3;OUTCAP CMP #$C1    ;CAP 'A' BCC OUTCP3 CMP #$DB    ;CAP 'Z' BCS OUTCP3 PHA LDA 53272 AND #2 BEQ OUTCP2 PLA BNE OUTCP3OUTCP2  PLA AND #$7FOUTCP3  JMP CHROUT;XMPOLY .BYT 13,5,M,'ULTI-TRANSFER - ',CP,'UNTER ONLY.',13,0CF1  ;MULTI-SEND JSR COSAVE LDA PROTOC BEQ MULSAVMULNOP LDA #<XMPOLY LDY #>XMPOLY JSR OUTSTR JMP ABORTXMULSAV LDA #$93 JSR CHROUT LDA BUFPTR+1 CMP #>MULFIL BCC MULSOK LDA BUFPTR CMP #<MULFIL BCC MULSOK LDA #<MLSWRN LDY #>MLSWRN JSR OUTSTR JMP ABORTXMULSOK  LDA #<MSNTXT LDY #>MSNTXT JSR OUTSTR LDA #<MOPTXT LDY #>MOPTXT JSR OUTSTR JSR MLTDIR LDA MULCNT BNE MLSS1MLSS0  JMP MLSSABMLSS1 LDA MULFLN STA MULCNT BEQ MLSS0 LDA #0 STA MULFLN LDA #<MULFIL STA $FD LDA #>MULFIL STA $FEMLSLOP LDY #19 LDA ($FD),Y BNE MLSSENMLSINC  LDA $FD CLC ADC #20 STA $FD LDA $FE ADC #0 STA $FE LDA $FE CMP #>ROUTPT BCC MLSLOP JMP MULAB2MLSSEN LDY #17MLSS2  LDA ($FD),Y CMP #160 BNE MLSS3 DEY CPY #01 BNE MLSS2 JMP MULAB2MLSS3  DEY STY MAX INYMLSS4  LDA ($FD),Y STA INPBUF-2,Y DEY CPY #01 BNE MLSS4 LDX MAX LDA #',' STA INPBUF,X LDY #18 LDA ($FD),Y AND #07 CMP #04 BNE MLSG JMP MULABTMLSG TAY LDA DRTYPE,Y STA INPBUF+1,XMLSGO JSR MLSHDR LDY #0MLSGO1  LDA INPBUF,Y JSR CHROUT INY CPY MAX BNE MLSGO1 LDA INPBUF,Y JSR CHROUT LDA INPBUF+1,Y JSR CHROUT LDA #$0D JSR CHROUT JSR CLRCHN JSR UPLMEN LDX 653 CPX #02 BEQ MULAB2 LDA INPBUF BNE MULAB2 INC MULFLN LDA MULFLN CMP MULCNT BEQ MLSS5 LDX #00 STX $A2MLSTIM  LDA $A2 CMP #110 BCC MLSTIM JMP MLSINCMLSS5 JSR MLSHDR LDX #16 LDA #04  ;CTRL-DMLSS6  JSR CHROUT DEX BNE MLSS6 LDA #$0D JSR CHROUTMLSSAB JSR CLRCHN JSR COBACK JSR GONG JMP TERMMLSHDR  LDX #5 JSR CHKOUT LDX #16 LDA #09  ;CTRL-IMLSCRI  JSR CHROUT DEX BNE MLSCRI RTSMULABT JSR GONGMULAB2 JSR CLRCHN LDA #$0D JSR CHROUT LDA #02 JSR CLOSE JMP TERM;CF3  ;MULTI-RECEIVE JSR COSAVE LDA PROTOC BEQ MULRAV JMP MULNOPMULRAV LDA #01 STA MULCNT LDA #$93 JSR CHROUT LDA #<MRCTXT LDY #>MRCTXT JSR OUTSTRMRLLGC LDX 653 BNE MRLLGCMLRNEW LDY #0 STY MAXMLRWAT LDX 653 CPX #02 BEQ MULAB2 LDX #05 JSR CHKIN JSR GETIN CMP #09 BNE MLRWATMLRWT2 LDX 653 CPX #02 BEQ MULAB2 JSR GETIN CMP #0 BEQ MLRWT2 CMP #9  ;CTRL-I BEQ MLRWT2 BNE MLRFL1MLRFLP LDX 653 CPX #02 BEQ MULAB2 LDX #5 JSR CHKIN JSR GETIN CMP #0 BEQ MLRFLPMLRFL1   CMP #$0D BEQ MLRFL2 LDY MAX STA INPBUF,Y INC MAX LDA MAX CMP #18 BCC MLRFLPMLRFL2 LDY MAX CPY #03 BCC MLFEXT DEY DEY LDA INPBUF,Y CMP #',' BNE MLFEXT STY MAX LDA INPBUF CMP #04   ;CTRL-D BNE MLFFL2MLFEXT  JMP MULABTMLFFL2 JSR DOWMEN LDA INPBUF BEQ MLRNEW BNE MLFEXT;GOOBAD STA 1844 CMP #'/' BEQ GOOBER CMP #'*' BNE GOOB2GOOBER  RTSGOOB2 CMP #':' BEQ GOOB3 LDX #3 BNE GOOB4GOOB3  LDX #25GOOB4  INC 1837,X LDA 1837,X CMP #':' BCC GOOBER LDA #'0' STA 1837,X DEX BPL GOOB4 RTS;MSNTXT .BYT 13,14,5,18,32,M,'ULTI-',CS,'END ',146,32,45,32 .BYT CS,'ELECT FILES:',13,13,0MOPTXT .BYT 154,32,CY,'ES/',N,'O/',Q,'UIT/',CS,'KIP8/',D,'ONE/' .BYT CA,'LL',13,0MRCTXT .BYT 13,14,5,18,32,M,'ULTI-',CR,'ECEIVE ',13,13 .BYT 159,W,'AITING FOR HEADER...',C,'= ABORTS.',13,0;MULTI - CHOOSE FILESMLTDIR LDA DISKDV JSR LISTEN LDA #$F0 JSR SECOND LDA #'$' JSR CIOUT LDA #'0' JSR CIOUT LDA #':' JSR CIOUT LDA #'*' JSR CIOUT JSR UNLSN LDA #<MULFIL STA $FD LDA #>MULFIL STA $FE LDA DISKDV JSR TALK LDA #$60 JSR TKSA LDY #0 STY MULCNT ;COUNT ENTRIES STY MULFLN STY MLSALL STY MULSKP LDY #31MDRLP0 JSR MGETCH DEY BPL MDRLP0 LDY #$01MDRLP1  JSR MGETCH DEY BPL MDRLP1 LDY #0 JSR MGETCH STA ($FD),Y STA $07E8,Y INY JSR MGETCH STA ($FD),Y STA $07E8,Y LDA #0 STA $06MDRLP2  JSR MGETCH INC $06 CMP #'"' BNE MDRLP2MDRLPF INY CPY #18 BEQ DRLPFN JSR MGETCH CMP #'"' BNE DRLPNQ LDA #160DRLPNQ STA ($FD),Y STA $07E8,Y JMP MDRLPFDRLPFN DEY CPY #01 BEQ DRLPTC LDA $07E8,Y CMP #' ' BNE DRLPTC LDA #160 STA ($FD),Y STA $07E8,Y BNE DRLPFNDRLPTC JSR MGETCH LDA #00 STA $05 JSR MGETCH CMP #'*' BNE DRLPSP LDA #$80 STA $05DRLPSP JSR MGETCH LDX #04DRLPTL CMP DRTYPE,X BEQ DRLPTP DEX BNE DRLPTLDRLPTP TXA ORA $05 STA $05 JSR MGETCH JSR MGETCH JSR MGETCH CMP #'<' BNE DRLPTE LDA $05 ORA #$40 STA $05DRLPTE  LDA $05 LDY #18 STA ($FD),Y STA $07E8,Y LDA #00 INY STA ($FD),YDIRGRB JSR MGETCH BNE DIRGRB INC MULCNT LDA MULSKP BNE MULPMT JSR MDRRET BNE MULNENMULPMT DEC MULSKP JSR DRPOL7MULNEN LDA DISKDV JSR TALK LDA #$60 JSR TKSA LDY #01 JMP MDRLP1MGETCH  JSR ACPTR LDX STATUS BNE MDRLP3 CMP #00 RTSMDRLP3  PLA PLAMDREXT  LDA DISKDV JSR LISTEN LDA #$E0 JSR SECOND JSR UNTLK JSR UNLSN JMP CLRCHNMDRRET LDY #0DRPOL0 STY $02 LDA DRFORM,Y CMP #02   ;CTRL-B BNE DRPOL1 LDY #00 LDA $07E8,Y TAX INY LDA $07E8,Y JSR $BDCD LDY $06DRPRBL LDA #' ' JSR CHROUT DEY BNE DRPRBL BEQ DRPOL4DRPOL1 CMP #$0E  ;CTRL-N BNE DRPOL2 LDY #02DRPRNM LDA $07E8,Y JSR CHROUT INY CPY #18 BNE DRPRNM BEQ DRPOL4DRPOL2 CMP #$06  ;CTRL-F BNE DRPOL3 LDY #18 LDA $07E8,Y TAY AND #07 TAX TYA AND #$80 BNE DRPRF1 LDA #' ' BNE DRPRF2DRPRF1  LDA #'*'DRPRF2  JSR CHROUT LDA DRTYPE,X JSR CHROUT LDA DRTYP2,X JSR CHROUT LDA DRTYP3,X JSR CHROUT TYA AND #$40 BNE DRPRF3 LDA #' ' BNE DRPRF4DRPRF3  LDA #'<'DRPRF4  JSR CHROUT BNE DRPOL4DRPOL3 JSR CHROUTDRPOL4 LDY $02 INY CPY #14 BEQ DRPOL5 JMP DRPOL0DRPOL5 LDA MLSALL BEQ MLSF0 LDA #'Y' JSR CHROUT BNE MLSYESMLSF0 LDA #' ' JSR CHROUT LDA #$9D JSR CHROUT JSR CURPRTMLSWLP  JSR GETIN BEQ MLSWLP AND #127 CMP #'A' BCC MLSWLP CMP #'[' BCS MLSWLP PHA JSR CUROFF PLA PHA JSR CHROUT LDA #$9D JSR CHROUT PLA CMP #'Y' BNE MLSF1MLSYES  LDY #19 INC MULFLN LDA #$80 STA ($FD),Y BNE MLSNPRMLSF1  CMP #'N' BEQ MLSNPR CMP #'A' BNE MLSF2 LDA #01 STA MLSALL BNE MLSYESMLSF2 CMP #'D' BNE MLSF3 LDA #$0D JSR CHROUT JMP MDRLP3MLSF3 CMP #'Q' BNE MLSF4 JSR MDREXT PLA PLA PLA PLA JSR CLRCHN JMP TERMMLSF4 CMP #'S' BNE MLSF0 LDA #07 STA MULSKPMLSNPR  LDA #$0D JSR CHROUTDRPOL7 LDA $FD CLC ADC #20 STA $FD LDA $FE ADC #0 STA $FE RTS;BUFTXT .BYT 5,B,'UFFER ',00BUFTX2 .BYT ' BYTES FREE.      ',13,2,'OPEN  ',2,'CLOSE  ',2,'ERASE  '.BYT 2,'TRANSFER',13,2,'LOAD  ',2,'SAVE   ',2,'PRINT  ',2,'VIEW: ',0OPNTXT .BYT O,'PEN  ',00CLOTXT .BYT C,'LOSED',00ERSTXT .BYT E,'RASE ',B,'UFFER! - ',2,'YES OR ',2,'NO?    ',157,157,157,0SNBTXT .BYT 13,13,CS,'ENDING ',B,'UFFER...',13,13,00DONTXT .BYT 13,13,5,D,'ONE.',13,0BUFMSG LDA #<BUFTXT LDY #>BUFTXT JSR OUTSTR LDA BUFFOC BEQ BUFMS1 LDA #<OPNTXT LDY #>OPNTXT CLC BCC BUFMS2BUFMS1 LDA #<CLOTXT LDY #>CLOTXTBUFMS2 JMP OUTSTRBUFPRM LDA #$0D JSR CHROUT JSR BUFMSG LDA #' ' JSR CHROUT LDA #'-' JSR CHROUT LDA #' ' JSR CHROUT LDA #<BUFEND SEC SBC BUFPTR TAX LDA #>BUFEND SBC BUFPTR+1 JSR OUTNUM LDA #<BUFTX2 LDY #>BUFTX2 JMP OUTSTRF4 LDX 653 CPX #02 BNE BUFFRC JMP CF3BUFFRC  ;BUFFER CMDS JSR COSAVE LDA #0 STA VISAUT LDA #13 STA F7MTXT+1 STA F7MTX1 LDA #10 STA TTDTXT+1 STA TTPTXT+1 STA TTNTXT+1 LDA #3 STA F7THOBBUFASK LDA #$0D JSR CHROUT JSR BUFPRMBUFWAT JSR SAVECHBUFLOP JSR GETIN BEQ BUFLOP AND #127 PHA JSR RESTCH PLA CMP #$0D BNE BUFCMDBUFEXT LDA #' ' JSR CHROUT LDA #$0D JSR CHROUT JSR CHROUT JSR COBACK JMP MAINBUFCMD CMP #'O' BNE BUFCM2 LDX #$01 STX BUFFOC BNE BUFEX1BUFCM2 CMP #'C' BNE BUFCM3 LDX #0 STX BUFFOCBUFEX1 ORA #$80BUFEXA JSR OUTCAP LDA #$0D JSR CHROUT LDA #145 ;CRSR UP LDX #04BUFEX2 JSR CHROUT DEX BPL BUFEX2 JMP BUFASKBUFCM3 CMP #'E' BNE BUFCM4 ORA #$80 JSR OUTCAP LDA #$0D JSR CHROUT LDA #145 LDX #02BUFER1 JSR CHROUT DEX BPL BUFER1 LDA #<ERSTXT LDY #>ERSTXT JSR OUTSTR JSR SAVECHBUFER2 JSR GETIN BEQ BUFER2 AND #127 CMP #'N' BEQ BUFER3 CMP #'Y' BNE BUFER2 JSR BUFCLRBUFER3 JSR RESTCH LDA #145 JSR CHROUT JSR CHROUT JMP BUFASKBUFCM4 CMP #'P' BNE BUFVEW ORA #$80 JSR OUTCAP JMP BUFPROBUFVEW CMP #'V' BNE BUFCM5 LDA #$93 JSR CHROUT LDA #$80 STA BUFFLG AND #0 STA BUFFL2 JSR PRTBUF JMP MAINPRTBUF ;BUF.TO SCREEN LDA BUFFST PHA LDA BUFFST+1 PHA LDA #$2F STA $00 LDA #$36 STA $01 JSR DSKOUT LDA #$37 STA $01 PLA STA BUFFST+1 PLA STA BUFFST RTSMEMGET LDX BUFFST CPX BUFPTR BCC MEMOK LDX BUFFST+1 CPX BUFPTR+1 BCC MEMOKMEMGAB LDX #$40 STX STATUS RTSMEMOK LDY #0 LDA (BUFFST),Y INC BUFFST BNE MEMEXT INC BUFFST+1MEMEXT LDX #0 STX STATUS RTSSKPBUF LDA BUFFST+1 CMP BUFPTR+1 BCS MEMGAB INC BUFFST+1SKPBF2 LDA BUFFST+1 CMP BUFPTR+1 BCC MEMEXT LDA BUFFST CMP BUFPTR BCS MEMGAB BCC MEMEXT;BUFCM5 CMP #'S' BNE BUFCM6 JSR SOLFIL JMP SAVBUFSOLFIL ORA #$80 JSR OUTCAP LDA #$0D JSR CHROUT JSR CHROUT JSR ENTFIL BNE SOLFOK JMP ABORTXSOLFOK  RTSSAVBUF LDA #0 STA MULCNT LDA #$02 STA PBUF+27 JSR DOWSFN LDA #$36 STA $01 LDA BUFFST STA $C1 LDA BUFFST+1 STA $C2 LDA BUFPTR CLC ADC #$01 STA $AE LDA BUFPTR+1 ADC #0 STA $AF LDA #$61 STA $B9 JSR $F3D5 JSR $F68F LDA $BA JSR $ED0C LDA $B9 JSR $EDB9 LDY #0 JSR $FB8E JSR $F624 PHP LDA #$37 STA $01 PLP BCC BSAVED LDA #$0D JSR CHROUT JSR BELL JMP ABORTXBSAVED JMP BUFEXTBUFCM6 CMP #'L' BNE BUFCM7 JSR SOLFILLODBUF LDA #$02 LDX DISKDV TAY JSR SETLFS LDA MAX LDX #<INPBUF LDY #>INPBUF JSR SETNAM JSR OPEN LDX #$02 JSR CHKINLODBFL JSR GETIN LDX STATUS BNE LODBEX LDX BUFPTR CPX #<BUFEND BNE LODBOK LDX BUFPTR+1 CPX #>BUFEND BEQ LODBEXLODBOK LDY #0 STA (BUFPTR),Y INC BUFPTR BNE LODBFL INC BUFPTR+1 BNE LODBFLLODBEX JSR CLRCHN LDA #$02 JSR CLOSE JMP BUFEXTBUFCM7 CMP #'T' BEQ SNDBUF CMP #'<' BEQ BUFCHG CMP #'>' BNE BUFBAKBUFCHG JSR CHGBPR JMP BUFEXABUFBAK JMP BUFWATSNDBUF ORA #$80 JSR OUTCAP LDA #<SNBTXT LDY #>SNBTXT JSR OUTSTR LDA #$FF STA BUFFLG STA BUFFL2 JSR PRTBUF JSR COSAVE LDA $029B STA $029C LDA #<DONTXT LDY #>DONTXT JSR OUTSTR JSR COBACK JMP MAINCHGBPR PHA CMP #'>' BEQ CHGBP3 LDA BUFPTR+1 CMP #>ENDPRG BNE CHGBP1 LDA BUFPTR CMP #<ENDPRG BEQ CHGBENCHGBP1 LDA BUFPTR BNE CHGBP2 DEC BUFPTR+1CHGBP2  DEC BUFPTR JMP CHGBENCHGBP3 LDA BUFPTR+1 CMP #>BUFEND BNE CHGBP4 LDA BUFPTR CMP #<BUFEND BEQ CHGBENCHGBP4 INC BUFPTR BNE CHGBEN INC BUFPTR+1CHGBEN LDX #1 STX 651 PLA RTS;BUFPDT .BYT 13,13,D,'EVICE: ',0BUFPDA .BYT 13,CS,'EC.',CA,'.: ',0BUFPDP .BYT $93,13,CP,'RINTING...',13,0BUFPRO LDA #<BUFPDT LDY #>BUFPDT LDX #1 JSR INPSET LDA #'4' JSR CHROUT JSR INPUTL BNE BUFPR2BUFPRA LDA #$0D JSR CHROUT JMP ABORTXBUFPR2 LDA INPBUF CMP #'3' BCC BUFPRA CMP #'6' BCS BUFPRA AND #$0F PHA LDA #<BUFPDA LDY #>BUFPDA LDX #1 JSR INPSET LDA #'7' JSR CHROUT JSR INPUTL BEQ BUFPRA LDA INPBUF CMP #'0' BCC BUFPRA CMP #':' BCS BUFPRA AND #$0F TAY PLA TAX LDA #4 JSR SETLFS LDA #0 JSR SETNAM LDA #<BUFPDP LDY #>BUFPDP JSR OUTSTR JSR OPEN LDX STATUS BNE BUFPR3 LDA BUFFST PHA LDA BUFFST+1 PHA LDA #$2F STA $00 LDA #$36 STA $01 JSR MEMPRO LDA #$37 STA $01 PLA STA BUFFST+1 PLA STA BUFFSTBUFPR3 LDA #4 JSR CLOSE LDA #<DONTXT LDY #>DONTXT JSR OUTSTR JSR COBACK JMP MAINMEMPROMEMPR2 JSR MEMGET BNE MEMPR3 PHA AND #$7F CMP #$0D BEQ MEMPRP CMP #$20 BCC MEMPABMEMPRP LDX #4 JSR CHKOUT PLA JSR CHROUT LDX STATUS BNE MEMPR3 JMP MEMPR2MEMPAB PLA JMP MEMPR2MEMPR3 JMP CLRCHN;ENTCOL .BYT 5HILCOL .BYT 158PHHTXT.BYT 19,13.BYT 5,18,161,C,CR,CS,CR,' KEYS',182,146,154,' - ',M,'OVE '.BYT 5,18,161,CR,E,T,U,CR,N,182,146,154,' - ',CS,'ELECT',13.BYT 159,2,'DIAL ',U,'NLISTED #  ',2,'EDIT ',C,'URRENT #',13.BYT 2,'CALL ',C,'URRENT #   ',2,'A-',D,'IAL ',CA,'LL ',CS,'ELECT',29,20.BYT 'D',157,148,'E',13,2,'REVERSE ',CA,'LL      ',2,'X-',CR,'ETURN TO '.BYT M,'ENU',13.BYT 152,3,5,0,18,'           >>>',CP,'HONE ',B,'OOK<<<           '.BYT 29,20,32,157,148,32,13,0STATTX .BYT 152,3,21,0,18,'                                      ',29,20.BYT 32,157,148,32,13,145,18,0STAPTX .BYT 152,3,21,0,18,32,0HP1MSG .BYT U,'SE +/-/',CR,E,T,U,CR,N,' TO SELECT:',0TOETXT .BYT 3,6,0,0CURBTX .BYT 3,22,1,159,N,'AME:',13,CP,'HONE:',13,32,B,'AUD: ',29,29,29,29.BYT '  ',T,'ERM: ',29,29,29,29,29,29,29,29,'  ',T,'RY: ',29CURBT2 .BYT 29,20,29,20,145,13,0GFXBBS .BYT G,'RAPHICS',0ASCBBS .BYT CA,CS,C,I,I,'   ',0NONTXT .BYT 5,'(',N,'ONE)             ',13,0CLRLNT .BYT 3,22,7,'                  ',3,22,7,5,0EMPBBS .BYT 151,164,164,164,164,164,164,164,164,164,164,164,164 .BYT 164,164,164,164,164,164CURBBS .BYT 146COLBBS .BYT 153NAMBBS .BYT '                ',146,5,0CURPIK .BYT 0TMPPIK .BYT 0BAUTMP .BYT 6GRATMP .BYT 0PRTSTT PHA TYA PHA LDA #<STAPTX LDY #>STAPTX JSR OUTSTR PLA TAY PLA JSR OUTSTR LDA #' 'PRTST2  LDX 211 CPX #39 BCS PRTST3 JSR CHROUT BNE PRTST2PRTST3  RTSPHNPTR LDA CURPIK STA NLOCAT LDA #52 STA NLOCAT+1 JSR MULTPY JMP PHNPT4MULTPY  CLC LDA #0 LDX #$08PHNPT2  ROR A ROR NLOCAT BCC PHNPT3 CLC ADC NLOCAT+1PHNPT3  DEX BPL PHNPT2 STA NLOCAT+1 RTSPHNPT4 LDA NLOCAT CLC ADC #<PHBMEM STA NLOCAT LDA NLOCAT+1 ADC #>PHBMEM STA NLOCAT+1 LDY #0 RTSONPENT LDA HILCOL BNE PRTEN0PRTENT LDA ENTCOLPRTEN0  STA COLBBSPRTEN1  LDA #146 STA CURBBS LDY #0 LDA (NLOCAT),Y BEQ PRTCUR LDA #18 STA CURBBSPRTCUR   LDY #2PRTEN2   LDA (NLOCAT),Y STA NAMBBS-2,Y INY CPY #20 BCC PRTEN2 LDA NAMBBS BNE PRTEN4 LDY #1PRTEN3  LDA EMPBBS,Y STA COLBBS,Y INY CPY #19 BCC PRTEN3 LDA COLBBS CMP HILCOL BEQ PRTEN4 LDA EMPBBS STA COLBBSPRTEN4 LDY #0PRTEN5  LDA CURBBS,Y BEQ PRTEN6 JSR CHROUT INY BNE PRTEN5PRTEN6  LDA #$0D JMP CHROUT;CLRENT LDA #0 STA CURPIKCLREN1 JSR PHNPTR LDA #0 STA (NLOCAT),Y INC CURPIK LDA CURPIK CMP #30 BCC CLREN1 RTS;PHINIT LDA #0 STA TRYCNT STA CURPIK JSR CLRCHN LDA #<PHHTXT LDY #>PHHTXT JSR OUTSTR LDA #<TOETXT LDY #>TOETXT JSR OUTSTRPHINI2 LDA #29 JSR CHROUT JSR PHNPTR JSR PRTENT INC CURPIK LDA CURPIK CMP #15 BCC PHINI2 LDA #<TOETXT LDY #>TOETXT JSR OUTSTRPHINI3  LDA #21  ;COL 21 STA 211 JSR PHNPTR JSR PRTENT INC CURPIK LDA CURPIK CMP #30 BCC PHINI3 LDA #<STATTX LDY #>STATTX JSR OUTSTR LDA #0 STA CURPIK LDA #<CURBTX LDY #>CURBTX JMP OUTSTRPHNROC .BYT 3,0,0,0ARROWT .BYT 32,93,93,32,60,125,109,62,32,32,0HILCUR LDX CURPIK INX TXA AND #$0F CLC ADC #5 STA PHNROC+1  ;ROW LDA #1 STA PHNROC+2  ;COL LDA CURPIK CMP #15 BCC HILCU2 INC PHNROC+1 LDA #21 STA PHNROC+2HILCU2 LDA COLBBS CMP HILCOL BNE HILCU7 LDX TOETXT+1HILCU3 LDA $ECF0,X STA NLOCAT LDA $D9,X AND #$7F STA NLOCAT+1 LDY #0 CPX PHNROC+1 BNE HILCU4 LDY #4 BNE HILCU5HILCU4 BCC HILCU5 LDY #8 BNE HILCU6HILCU5 LDA PHNROC+2 CMP #20 BCC HILCU6 INY INYHILCU6 LDA ARROWT,Y PHA LDA ARROWT+1,Y LDY #20 STA (NLOCAT),Y PLA DEY STA (NLOCAT),Y LDA NLOCAT+1 CLC ADC #212 STA NLOCAT+1 LDA #5  ;GREEN STA (NLOCAT),Y INY STA (NLOCAT),Y INX CPX #21 BCC HILCU3HILCU7 LDA #<PHNROC LDY #>PHNROC JSR OUTSTR JSR PHNPTR JMP PRTEN1POSNAM LDX CURBTX+1 DEX STX 214 LDA #$0D JSR CHROUT LDA #7  ;START AT COL 7 STA 211 RTS.FIL 5C.GS